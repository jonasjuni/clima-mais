# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

pool:
  vmImage: ubuntu-latest

stages:
  - stage: Build
    displayName: Building
    jobs:
      - job: Install_Flutter
        displayName: Installing flutter...
        steps:
        - task: FlutterInstall@0
          inputs:
            mode: 'auto'
            channel: 'stable'
            version: 'latest'
        - task: DownloadSecureFile@1
          name: keystore
          inputs:
            secureFile: 'upload-keystore.jks'

        - task: DownloadSecureFile@1
          name: key
          inputs:
            secureFile: 'key.properties'
            
        - script: ln -s -t $(System.DefaultWorkingDirectory)/android/ $(key.secureFilePath)
        
        - task: FlutterCommand@0
          inputs:
            projectDirectory: '.'
            arguments: '-v gen-l10n'
        - task: FlutterBuild@0
          inputs:
            target: 'aab'
            projectDirectory: '.'
        - task: ArchiveFiles@2
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)/build/app/outputs/bundle/release/app-release.aab'
            includeRootFolder: false
            archiveType: tar
            archiveFile: $(Build.ArtifactStagingDirectory)/clima_mais-$(Build.BuildId).tar.gz
            replaceExistingArchive: true
        - publish: $(Build.ArtifactStagingDirectory)/clima_mais-$(Build.BuildId).tar.gz
          artifact: android